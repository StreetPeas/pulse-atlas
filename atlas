#!/bin/bash
set -e

cmd="${1:-–ø–æ–º–æ—â—å}"
shift || true

case "$cmd" in
  –ø–æ–º–æ—â—å|help|-h|--help)
    cat <<'TXT'
ATLAS (–∫–æ–º–∞–Ω–¥—ã)

  ./atlas —Å—Ç–∞—Ç—É—Å
        —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (–±–∞–∑–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)

  ./atlas –ø–æ–∫–∞–∑–∞—Ç—å [N]
        –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–∏–≥–Ω–∞–ª–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)

  ./atlas –¥–æ–±–∞–≤–∏—Ç—å "–¢–ï–ö–°–¢"
        –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª (manual/test)

  ./atlas —Ä–∏—Å–∫ "–¢–ï–ö–°–¢"
        –¥–æ–±–∞–≤–∏—Ç—å risk-—Å–∏–≥–Ω–∞–ª (tags: risk,market)

–ü—Ä–∏–º–µ—Ä—ã:
  ./atlas —Å—Ç–∞—Ç—É—Å
  ./atlas –ø–æ–∫–∞–∑–∞—Ç—å 5
  ./atlas –¥–æ–±–∞–≤–∏—Ç—å "–Ω–æ–≤–æ—Å—Ç—å: —Ä—ã–Ω–æ–∫ –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç"
  ./atlas —Ä–∏—Å–∫ "SEC lawsuit rumor, exploit claims spreading"
TXT
    ;;

  —Å—Ç–∞—Ç—É—Å|status)
    echo "DIR: $(pwd)"
    echo "DB : data/atlas.db"
    if [ ! -f data/atlas.db ]; then
      echo "DB missing"
      exit 2
    fi
    echo -n "signals: "
    sqlite3 data/atlas.db "select count(*) from signals;"
    echo "--- last 3 ---"
    python3 signals_cli.py list --limit 3
    ;;

  x)
    nick="${1:-}"
    text="${2:-}"
    url="${3:-}"
    if [ -z "$nick" ] || [ -z "$text" ]; then
      echo '–ù—É–∂–Ω–æ: ./atlas x "@–Ω–∏–∫" "–¢–ï–ö–°–¢" ["URL"]'
      exit 2
    fi
    if [ -z "$url" ]; then
      python3 signals_cli.py signal --source x --origin "$nick" --text "$text"
    else
      python3 signals_cli.py signal --source x --origin "$nick" --url "$url" --text "$text"
    fi
    ;;

  —Ä–∏—Å–∫–∏|risklist)
    n="${1:-10}"
    if [ ! -f data/atlas.db ]; then
      echo "DB missing"
      exit 2
    fi
    sqlite3 data/atlas.db "select id, color, label, round(score,2), source, coalesce(origin,'-'), ts from signals where label='risk' order by id desc limit $n;"
    ;;

  –Ω–µ–π—Ç—Ä|neutrlist)
    n="${1:-10}"
    if [ ! -f data/atlas.db ]; then
      echo "DB missing"
      exit 2
    fi
    sqlite3 data/atlas.db "select id, color, label, round(score,2), source, coalesce(origin,'-'), ts from signals where label='neutral' order by id desc limit $n;"
    ;;

  –∫—Ä–∞—Å–Ω—ã–µ|red)
    n="${1:-10}"
    if [ ! -f data/atlas.db ]; then
      echo "DB missing"
      exit 2
    fi
    sqlite3 data/atlas.db "select id, color, label, round(score,2), source, coalesce(origin,'-'), ts from signals where color='üî¥' order by id desc limit $n;"
    ;;

  –ø—É–ª—å—Å|pulse)
    h="${1:-24}"
    if [ ! -f data/atlas.db ]; then
      echo "DB missing"
      exit 2
    fi
    echo "PULSE (${h}h):"
    sqlite3 data/atlas.db "
      SELECT
        'üî¥ ' || SUM(CASE WHEN color='üî¥' THEN 1 ELSE 0 END) ||
        ' | üü† ' || SUM(CASE WHEN color='üü†' THEN 1 ELSE 0 END) ||
        ' | üü° ' || SUM(CASE WHEN color='üü°' THEN 1 ELSE 0 END) ||
        ' | üü¢ ' || SUM(CASE WHEN color='üü¢' THEN 1 ELSE 0 END) ||
        ' | ‚ö´ ' || SUM(CASE WHEN color='‚ö´' THEN 1 ELSE 0 END)
      FROM signals
      WHERE ts >= datetime('now', '-' || $h || ' hours');
    "
    ;;

  –ø–æ–∫–∞–∑–∞—Ç—å|list)
    n="${1:-10}"
    python3 signals_cli.py list --limit "$n"
    ;;

  –¥–æ–±–∞–≤–∏—Ç—å|add)
    text="${1:-}"
    if [ -z "$text" ]; then
      echo '–ù—É–∂–Ω–æ: ./atlas –¥–æ–±–∞–≤–∏—Ç—å "–¢–ï–ö–°–¢"'
      exit 2
    fi
    python3 signals_cli.py signal --source manual --origin test --text "$text"
    ;;

  —Ä–∏—Å–∫|risk)
    text="${1:-}"
    if [ -z "$text" ]; then
      echo '–ù—É–∂–Ω–æ: ./atlas —Ä–∏—Å–∫ "–¢–ï–ö–°–¢"'
      exit 2
    fi
    python3 signals_cli.py signal --source manual --origin test --tags "risk,market" --text "$text"
    ;;

  *)
    echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $cmd"
    echo "–ù–∞–ø–∏—à–∏: ./atlas –ø–æ–º–æ—â—å"
    exit 2
    ;;
esac
